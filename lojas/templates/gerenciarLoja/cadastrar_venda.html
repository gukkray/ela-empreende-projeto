{% extends "modelo.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block titulo %}
<title>Cadastrar Vendas</title>
{% endblock %}
<link href="{% static 'img/icon.png' %}" rel="icon">

{% block corpo %}
<div class="container">
    <!DOCTYPE html>
    <html lang="en">

    <head>
        <meta charset="UTF-8">
        <title>Criar Venda</title>
    </head>

    <body>
        <h1>Criar Venda</h1>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.as_p }}

            <div id="produtos-formset">
                {{ form.produtos.management_form }}
                {% for produto_form in form.produtos %}
                {{ produto_form }}
                {% endfor %}
            </div>

            <button type="button" id="add-produto-btn">Adicionar Produto</button>
            <input type="submit" value="Salvar">
        </form>



    </body>

    </html>
</div>

<script>
    // Adicionando evento de clique ao botão de adicionar produto
    document.getElementById("adicionar-produto").addEventListener("click", function () {
        // Obtendo o valor do produto selecionado
        var produtoSelecionado = document.getElementById("id_produtos").value;

        // Obtendo o texto do produto selecionado
        var produtoSelecionadoText = document.getElementById("id_produtos").options[document.getElementById("id_produtos").selectedIndex].text;

        // Adicionando o produto à lista de produtos adicionados
        document.getElementById("produtos-adicionados").innerHTML += '<input type="hidden" name="produtos" value="' + produtoSelecionado + '"><p>' + produtoSelecionadoText + '</p>';
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('add-produto-btn').addEventListener('click', function () {
            var formset = document.getElementById('produtos-formset');
            var totalForms = parseInt(formset.querySelector('#id_produtos-TOTAL_FORMS').value);
            var newFormIdx = totalForms;

            // Clone the last form in the formset
            var newForm = formset.querySelector('.produto-form:last-child').cloneNode(true);

            // Update the IDs and names of the new form fields
            var formRegex = RegExp('produtos-(\\d{1,})-', 'g');
            var formsetPrefix = 'produtos-' + newFormIdx + '-';
            newForm.innerHTML = newForm.innerHTML.replace(formRegex, formsetPrefix);

            // Clear the values of the new form fields
            newForm.querySelectorAll('input[type="text"], input[type="number"]').forEach(function (input) {
                input.value = '';
            });

            // Increment the total form count and set it in the formset management form
            totalForms++;
            formset.querySelector('#id_produtos-TOTAL_FORMS').setAttribute('value', totalForms);

            // Append the new form to the formset
            formset.insertBefore(newForm, document.getElementById('add-produto-btn'));
        });
    });
</script>

{% endblock %}